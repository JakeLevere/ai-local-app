<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coordinate Verification Tool - Test Facial Detection Accuracy</title>
  <style>
    :root {
      --bg: #0f1220; 
      --panel: #161a2b; 
      --text: #e8ecff; 
      --accent: #8ad1ff; 
      --green: #35d49b; 
      --red: #ff6b6b; 
      --yellow: #ffd166; 
      --magenta: #ff7dd8;
      --card: #1b2036; 
      --border: #262c49;
    }
    
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.45 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      padding: 20px;
    }
    
    h1 {
      color: var(--accent);
      margin-bottom: 10px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
    }
    
    .canvas-container {
      position: relative;
      display: inline-block;
    }
    
    canvas {
      border: 2px solid var(--border);
      border-radius: 10px;
      cursor: crosshair;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    
    .controls {
      margin-top: 15px;
    }
    
    button {
      background: #233056;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    button:hover {
      background: #2a3a6a;
    }
    
    button.active {
      background: var(--accent);
      color: #001020;
    }
    
    input[type="file"] {
      margin-bottom: 15px;
    }
    
    .stats {
      background: var(--card);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
    }
    
    .stat-row {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      padding: 5px 10px;
      background: #0b0f1e;
      border-radius: 6px;
    }
    
    .confidence-high { color: var(--green); }
    .confidence-medium { color: var(--yellow); }
    .confidence-low { color: var(--red); }
    
    .coordinate-display {
      font-family: monospace;
      background: #0b0f1e;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    .legend {
      display: flex;
      gap: 20px;
      margin: 15px 0;
      font-size: 12px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid white;
    }
    
    textarea {
      width: 100%;
      min-height: 300px;
      background: #0b0f1e;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
    }
    
    .accuracy-meter {
      width: 100%;
      height: 30px;
      background: #0b0f1e;
      border-radius: 15px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .accuracy-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--red), var(--yellow), var(--green));
      transition: width 0.3s ease;
    }
    
    .overlay-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(22, 26, 43, 0.9);
      padding: 10px;
      border-radius: 8px;
      font-size: 11px;
    }
    
    .mode-indicator {
      padding: 5px 10px;
      background: var(--accent);
      color: #001020;
      border-radius: 6px;
      font-weight: bold;
      display: inline-block;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ¯ Coordinate Verification Tool</h1>
    <p>Test and improve facial landmark detection accuracy by comparing manual vs AI detection</p>
    
    <div class="grid">
      <!-- Left Panel: Manual Marking -->
      <div class="panel">
        <h2>Manual Ground Truth</h2>
        <div class="mode-indicator">MANUAL MODE</div>
        
        <input type="file" id="imageInput" accept="image/*" />
        
        <div class="canvas-container">
          <canvas id="manualCanvas" width="360" height="360"></canvas>
          <div class="overlay-controls">
            <div>Click to place points</div>
            <div>Current: <span id="currentPoint">leftEye</span></div>
          </div>
        </div>
        
        <div class="legend">
          <div class="legend-item">
            <div class="legend-dot" style="background: var(--yellow);"></div>
            <span>Left Eye (L key)</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: var(--yellow);"></div>
            <span>Right Eye (R key)</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: var(--magenta);"></div>
            <span>Mouth (M key)</span>
          </div>
        </div>
        
        <div class="controls">
          <button id="btnLeftEye" class="active">Left Eye (L)</button>
          <button id="btnRightEye">Right Eye (R)</button>
          <button id="btnMouth">Mouth (M)</button>
          <button id="clearManual">Clear All</button>
        </div>
        
        <div class="coordinate-display">
          <div>Left Eye: <span id="manualLeftEye">(not set)</span></div>
          <div>Right Eye: <span id="manualRightEye">(not set)</span></div>
          <div>Mouth: <span id="manualMouth">(not set)</span></div>
        </div>
      </div>
      
      <!-- Right Panel: AI Detection -->
      <div class="panel">
        <h2>AI Detection</h2>
        <div class="mode-indicator" style="background: var(--magenta);">AI MODE</div>
        
        <div class="canvas-container">
          <canvas id="aiCanvas" width="360" height="360"></canvas>
        </div>
        
        <div class="controls">
          <button id="runDetection">Run AI Detection</button>
          <button id="compareResults">Compare Results</button>
        </div>
        
        <div class="coordinate-display">
          <div>Left Eye: <span id="aiLeftEye">(not detected)</span></div>
          <div>Right Eye: <span id="aiRightEye">(not detected)</span></div>
          <div>Mouth: <span id="aiMouth">(not detected)</span></div>
        </div>
        
        <div class="stats">
          <h3>Accuracy Metrics</h3>
          <div class="accuracy-meter">
            <div class="accuracy-fill" id="accuracyBar" style="width: 0%;"></div>
          </div>
          <div class="stat-row">
            <span>Overall Accuracy:</span>
            <span id="overallAccuracy" class="confidence-low">0%</span>
          </div>
          <div class="stat-row">
            <span>Avg Distance Error:</span>
            <span id="avgDistance">0 px</span>
          </div>
          <div class="stat-row">
            <span>Left Eye Error:</span>
            <span id="leftEyeError">0 px</span>
          </div>
          <div class="stat-row">
            <span>Right Eye Error:</span>
            <span id="rightEyeError">0 px</span>
          </div>
          <div class="stat-row">
            <span>Mouth Error:</span>
            <span id="mouthError">0 px</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Analysis Results -->
    <div class="panel" style="margin-top: 20px;">
      <h2>Analysis Results</h2>
      <textarea id="analysisOutput" readonly>
Load an image and mark ground truth points, then run AI detection to see comparison results...
      </textarea>
      
      <div class="controls">
        <button id="exportResults">Export Results as JSON</button>
        <button id="testEnhanced">Test with Enhanced Detection</button>
        <button id="generateReport">Generate Accuracy Report</button>
      </div>
    </div>
  </div>
  
  <script>
    const app = {
      currentImage: null,
      currentPoint: 'leftEye',
      manualPoints: {
        leftEye: null,
        rightEye: null,
        mouth: null
      },
      aiPoints: {
        leftEye: null,
        rightEye: null,
        mouth: null
      },
      scale: 3
    };
    
    const manualCanvas = document.getElementById('manualCanvas');
    const aiCanvas = document.getElementById('aiCanvas');
    const manualCtx = manualCanvas.getContext('2d');
    const aiCtx = aiCanvas.getContext('2d');
    
    // Disable image smoothing for pixel-perfect rendering
    manualCtx.imageSmoothingEnabled = false;
    aiCtx.imageSmoothingEnabled = false;
    
    // Image loading
    document.getElementById('imageInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async (event) => {
        const img = new Image();
        img.onload = () => {
          app.currentImage = img;
          
          // Draw on both canvases
          manualCtx.fillStyle = '#000';
          manualCtx.fillRect(0, 0, 360, 360);
          aiCtx.fillStyle = '#000';
          aiCtx.fillRect(0, 0, 360, 360);
          
          // Calculate scaling to fit 120x120 center
          const scale = Math.min(120 / img.width, 120 / img.height);
          const w = img.width * scale;
          const h = img.height * scale;
          const x = (120 - w) / 2;
          const y = (120 - h) / 2;
          
          // Draw scaled image (will be pixel-perfect at 3x scale)
          manualCtx.drawImage(img, x * 3, y * 3, w * 3, h * 3);
          aiCtx.drawImage(img, x * 3, y * 3, w * 3, h * 3);
          
          // Clear previous points
          app.manualPoints = { leftEye: null, rightEye: null, mouth: null };
          app.aiPoints = { leftEye: null, rightEye: null, mouth: null };
          updateDisplays();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });
    
    // Point selection buttons
    document.getElementById('btnLeftEye').addEventListener('click', () => selectPoint('leftEye'));
    document.getElementById('btnRightEye').addEventListener('click', () => selectPoint('rightEye'));
    document.getElementById('btnMouth').addEventListener('click', () => selectPoint('mouth'));
    
    function selectPoint(point) {
      app.currentPoint = point;
      document.querySelectorAll('.controls button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`btn${point.charAt(0).toUpperCase() + point.slice(1)}`).classList.add('active');
      document.getElementById('currentPoint').textContent = point;
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'l' || e.key === 'L') selectPoint('leftEye');
      if (e.key === 'r' || e.key === 'R') selectPoint('rightEye');
      if (e.key === 'm' || e.key === 'M') selectPoint('mouth');
    });
    
    // Manual canvas clicking
    manualCanvas.addEventListener('click', (e) => {
      const rect = manualCanvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) / 3);
      const y = Math.floor((e.clientY - rect.top) / 3);
      
      app.manualPoints[app.currentPoint] = { x, y, confidence: 1.0 };
      drawManualPoints();
      updateDisplays();
      
      // Auto-advance to next point
      if (app.currentPoint === 'leftEye') selectPoint('rightEye');
      else if (app.currentPoint === 'rightEye') selectPoint('mouth');
    });
    
    function drawManualPoints() {
      // Redraw image
      if (app.currentImage) {
        manualCtx.fillStyle = '#000';
        manualCtx.fillRect(0, 0, 360, 360);
        const scale = Math.min(120 / app.currentImage.width, 120 / app.currentImage.height);
        const w = app.currentImage.width * scale;
        const h = app.currentImage.height * scale;
        const x = (120 - w) / 2;
        const y = (120 - h) / 2;
        manualCtx.drawImage(app.currentImage, x * 3, y * 3, w * 3, h * 3);
      }
      
      // Draw points
      drawPoint(manualCtx, app.manualPoints.leftEye, '#ffd166', 'L');
      drawPoint(manualCtx, app.manualPoints.rightEye, '#ffd166', 'R');
      drawPoint(manualCtx, app.manualPoints.mouth, '#ff7dd8', 'M');
    }
    
    function drawAIPoints() {
      // Redraw image
      if (app.currentImage) {
        aiCtx.fillStyle = '#000';
        aiCtx.fillRect(0, 0, 360, 360);
        const scale = Math.min(120 / app.currentImage.width, 120 / app.currentImage.height);
        const w = app.currentImage.width * scale;
        const h = app.currentImage.height * scale;
        const x = (120 - w) / 2;
        const y = (120 - h) / 2;
        aiCtx.drawImage(app.currentImage, x * 3, y * 3, w * 3, h * 3);
      }
      
      // Draw AI points with confidence-based colors
      drawPointWithConfidence(aiCtx, app.aiPoints.leftEye, 'L');
      drawPointWithConfidence(aiCtx, app.aiPoints.rightEye, 'R');
      drawPointWithConfidence(aiCtx, app.aiPoints.mouth, 'M');
    }
    
    function drawPoint(ctx, point, color, label) {
      if (!point) return;
      
      ctx.strokeStyle = color;
      ctx.fillStyle = color;
      ctx.lineWidth = 2;
      
      // Draw crosshair
      ctx.beginPath();
      ctx.moveTo(point.x * 3 - 10, point.y * 3);
      ctx.lineTo(point.x * 3 + 10, point.y * 3);
      ctx.moveTo(point.x * 3, point.y * 3 - 10);
      ctx.lineTo(point.x * 3, point.y * 3 + 10);
      ctx.stroke();
      
      // Draw circle
      ctx.beginPath();
      ctx.arc(point.x * 3, point.y * 3, 6, 0, Math.PI * 2);
      ctx.stroke();
      
      // Draw label
      ctx.font = 'bold 14px monospace';
      ctx.fillText(label, point.x * 3 + 10, point.y * 3 - 10);
    }
    
    function drawPointWithConfidence(ctx, point, label) {
      if (!point) return;
      
      // Color based on confidence
      let color;
      if (point.confidence > 0.8) color = '#35d49b';
      else if (point.confidence > 0.5) color = '#ffd166';
      else color = '#ff6b6b';
      
      drawPoint(ctx, point, color, label);
      
      // Draw confidence text
      ctx.fillStyle = color;
      ctx.font = '11px monospace';
      ctx.fillText(`${(point.confidence * 100).toFixed(0)}%`, point.x * 3 + 10, point.y * 3 + 20);
    }
    
    function updateDisplays() {
      // Update manual coordinates
      document.getElementById('manualLeftEye').textContent = 
        app.manualPoints.leftEye ? `(${app.manualPoints.leftEye.x}, ${app.manualPoints.leftEye.y})` : '(not set)';
      document.getElementById('manualRightEye').textContent = 
        app.manualPoints.rightEye ? `(${app.manualPoints.rightEye.x}, ${app.manualPoints.rightEye.y})` : '(not set)';
      document.getElementById('manualMouth').textContent = 
        app.manualPoints.mouth ? `(${app.manualPoints.mouth.x}, ${app.manualPoints.mouth.y})` : '(not set)';
      
      // Update AI coordinates
      document.getElementById('aiLeftEye').textContent = 
        app.aiPoints.leftEye ? 
        `(${app.aiPoints.leftEye.x}, ${app.aiPoints.leftEye.y}) - ${(app.aiPoints.leftEye.confidence * 100).toFixed(0)}%` : 
        '(not detected)';
      document.getElementById('aiRightEye').textContent = 
        app.aiPoints.rightEye ? 
        `(${app.aiPoints.rightEye.x}, ${app.aiPoints.rightEye.y}) - ${(app.aiPoints.rightEye.confidence * 100).toFixed(0)}%` : 
        '(not detected)';
      document.getElementById('aiMouth').textContent = 
        app.aiPoints.mouth ? 
        `(${app.aiPoints.mouth.x}, ${app.aiPoints.mouth.y}) - ${(app.aiPoints.mouth.confidence * 100).toFixed(0)}%` : 
        '(not detected)';
    }
    
    // Clear manual points
    document.getElementById('clearManual').addEventListener('click', () => {
      app.manualPoints = { leftEye: null, rightEye: null, mouth: null };
      drawManualPoints();
      updateDisplays();
    });
    
    // Run AI detection (mock - replace with actual API call)
    document.getElementById('runDetection').addEventListener('click', async () => {
      if (!app.currentImage) {
        alert('Please load an image first');
        return;
      }
      
      // Simulate AI detection with some variance
      // In real implementation, this would call your AI model
      app.aiPoints = {
        leftEye: { 
          x: 40 + Math.random() * 10 - 5, 
          y: 45 + Math.random() * 10 - 5, 
          confidence: 0.7 + Math.random() * 0.3 
        },
        rightEye: { 
          x: 80 + Math.random() * 10 - 5, 
          y: 45 + Math.random() * 10 - 5, 
          confidence: 0.7 + Math.random() * 0.3 
        },
        mouth: { 
          x: 60 + Math.random() * 10 - 5, 
          y: 85 + Math.random() * 10 - 5, 
          confidence: 0.6 + Math.random() * 0.4 
        }
      };
      
      drawAIPoints();
      updateDisplays();
      compareResults();
    });
    
    // Compare results
    document.getElementById('compareResults').addEventListener('click', compareResults);
    
    function compareResults() {
      if (!app.manualPoints.leftEye || !app.manualPoints.rightEye || !app.manualPoints.mouth) {
        alert('Please mark all manual points first');
        return;
      }
      
      if (!app.aiPoints.leftEye || !app.aiPoints.rightEye || !app.aiPoints.mouth) {
        alert('Please run AI detection first');
        return;
      }
      
      // Calculate distances
      const leftEyeDist = calculateDistance(app.manualPoints.leftEye, app.aiPoints.leftEye);
      const rightEyeDist = calculateDistance(app.manualPoints.rightEye, app.aiPoints.rightEye);
      const mouthDist = calculateDistance(app.manualPoints.mouth, app.aiPoints.mouth);
      
      const avgDist = (leftEyeDist + rightEyeDist + mouthDist) / 3;
      const maxAcceptableError = 10; // pixels
      const accuracy = Math.max(0, Math.min(100, 100 - (avgDist / maxAcceptableError * 100)));
      
      // Update displays
      document.getElementById('leftEyeError').textContent = `${leftEyeDist.toFixed(1)} px`;
      document.getElementById('rightEyeError').textContent = `${rightEyeDist.toFixed(1)} px`;
      document.getElementById('mouthError').textContent = `${mouthDist.toFixed(1)} px`;
      document.getElementById('avgDistance').textContent = `${avgDist.toFixed(1)} px`;
      document.getElementById('overallAccuracy').textContent = `${accuracy.toFixed(1)}%`;
      
      // Update accuracy bar
      document.getElementById('accuracyBar').style.width = `${accuracy}%`;
      
      // Color code accuracy
      const accElement = document.getElementById('overallAccuracy');
      accElement.classList.remove('confidence-high', 'confidence-medium', 'confidence-low');
      if (accuracy > 80) accElement.classList.add('confidence-high');
      else if (accuracy > 60) accElement.classList.add('confidence-medium');
      else accElement.classList.add('confidence-low');
      
      // Generate analysis report
      const report = generateAnalysisReport();
      document.getElementById('analysisOutput').value = report;
    }
    
    function calculateDistance(p1, p2) {
      const dx = p1.x - p2.x;
      const dy = p1.y - p2.y;
      return Math.sqrt(dx * dx + dy * dy);
    }
    
    function generateAnalysisReport() {
      const leftEyeDist = calculateDistance(app.manualPoints.leftEye, app.aiPoints.leftEye);
      const rightEyeDist = calculateDistance(app.manualPoints.rightEye, app.aiPoints.rightEye);
      const mouthDist = calculateDistance(app.manualPoints.mouth, app.aiPoints.mouth);
      const avgDist = (leftEyeDist + rightEyeDist + mouthDist) / 3;
      
      return `COORDINATE VERIFICATION REPORT
=====================================
Timestamp: ${new Date().toISOString()}

MANUAL GROUND TRUTH:
- Left Eye:  (${app.manualPoints.leftEye.x.toFixed(1)}, ${app.manualPoints.leftEye.y.toFixed(1)})
- Right Eye: (${app.manualPoints.rightEye.x.toFixed(1)}, ${app.manualPoints.rightEye.y.toFixed(1)})
- Mouth:     (${app.manualPoints.mouth.x.toFixed(1)}, ${app.manualPoints.mouth.y.toFixed(1)})

AI DETECTION RESULTS:
- Left Eye:  (${app.aiPoints.leftEye.x.toFixed(1)}, ${app.aiPoints.leftEye.y.toFixed(1)}) - Confidence: ${(app.aiPoints.leftEye.confidence * 100).toFixed(1)}%
- Right Eye: (${app.aiPoints.rightEye.x.toFixed(1)}, ${app.aiPoints.rightEye.y.toFixed(1)}) - Confidence: ${(app.aiPoints.rightEye.confidence * 100).toFixed(1)}%
- Mouth:     (${app.aiPoints.mouth.x.toFixed(1)}, ${app.aiPoints.mouth.y.toFixed(1)}) - Confidence: ${(app.aiPoints.mouth.confidence * 100).toFixed(1)}%

ERROR ANALYSIS:
- Left Eye Error:  ${leftEyeDist.toFixed(2)} pixels
- Right Eye Error: ${rightEyeDist.toFixed(2)} pixels
- Mouth Error:     ${mouthDist.toFixed(2)} pixels
- Average Error:   ${avgDist.toFixed(2)} pixels

ACCURACY METRICS:
- Overall Accuracy: ${(100 - (avgDist / 10 * 100)).toFixed(1)}%
- Average Confidence: ${((app.aiPoints.leftEye.confidence + app.aiPoints.rightEye.confidence + app.aiPoints.mouth.confidence) / 3 * 100).toFixed(1)}%

RECOMMENDATIONS:
${generateRecommendations(leftEyeDist, rightEyeDist, mouthDist)}`;
    }
    
    function generateRecommendations(leftErr, rightErr, mouthErr) {
      let recommendations = [];
      
      if (leftErr > 10 || rightErr > 10) {
        recommendations.push('- Eye detection needs improvement. Consider adjusting lighting or image contrast.');
      }
      if (mouthErr > 15) {
        recommendations.push('- Mouth detection is inaccurate. Check for occlusions or shadows.');
      }
      if (Math.abs(leftErr - rightErr) > 5) {
        recommendations.push('- Asymmetric eye detection errors. Face might be tilted or partially occluded.');
      }
      
      const avgConfidence = (app.aiPoints.leftEye.confidence + app.aiPoints.rightEye.confidence + app.aiPoints.mouth.confidence) / 3;
      if (avgConfidence < 0.7) {
        recommendations.push('- Low confidence scores. Consider image enhancement before detection.');
      }
      
      if (recommendations.length === 0) {
        recommendations.push('- Detection accuracy is good! Results are within acceptable range.');
      }
      
      return recommendations.join('\n');
    }
    
    // Export results
    document.getElementById('exportResults').addEventListener('click', () => {
      const data = {
        timestamp: new Date().toISOString(),
        manual: app.manualPoints,
        ai: app.aiPoints,
        analysis: {
          leftEyeError: calculateDistance(app.manualPoints.leftEye || {x:0,y:0}, app.aiPoints.leftEye || {x:0,y:0}),
          rightEyeError: calculateDistance(app.manualPoints.rightEye || {x:0,y:0}, app.aiPoints.rightEye || {x:0,y:0}),
          mouthError: calculateDistance(app.manualPoints.mouth || {x:0,y:0}, app.aiPoints.mouth || {x:0,y:0})
        }
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `verification-${Date.now()}.json`;
      a.click();
    });
  </script>
</body>
</html>
