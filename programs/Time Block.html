<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weekly Calendar</title>
  <style>
    :root {
      --bg-dark: #202124;
      --sidebar-dark: #303134;
      --cell-border: #3c4043;
      --text-light: #e8eaed;
      --event-bg: #5f6368;
      --highlight-border: #8ab4f8;
      --scroll-thumb: #5f6368;
      --scroll-track: #2b2c2e;
      --header-bg: #26282b;
      --today-bg: rgba(138, 180, 248, 0.08);
      --input-bg: #202124;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      height: 100vh;
      background-color: var(--bg-dark);
      color: var(--text-light);
      overflow: hidden;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--scroll-track);
    }

    ::-webkit-scrollbar-thumb {
      background-color: var(--scroll-thumb);
      border-radius: 10px;
    }

    .sidebar {
      width: 20%;
      min-width: 200px;
      max-width: 220px;
      background: var(--sidebar-dark);
      border-right: 1px solid var(--cell-border);
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    .sidebar-controls {
        padding: 8px;
        border-bottom: 1px solid var(--cell-border);
    }
    
    .new-category-input {
      display: flex;
      gap: 5px;
    }

    .new-category-input input {
      flex-grow: 1;
      padding: 4px 6px;
      background: var(--input-bg);
      border: 1px solid var(--cell-border);
      color: var(--text-light);
      border-radius: 4px;
      font-size: 12px;
    }

    .new-category-input button {
      padding: 4px 8px;
      background: #5a78c9;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
    }
     .new-category-input button:hover {
        background: #6b88d9;
     }

    .task-groups {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .task-group {
      margin-bottom: 8px;
    }

    .task-header {
      font-weight: 600;
      cursor: pointer;
      padding: 4px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.85em;
    }

    .task-header-title {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-grow: 1; /* Allow title to take available space */
    }
    
    .add-task-header-btn {
        background: none;
        border: none;
        color: #8ab4f8;
        cursor: pointer;
        font-size: 1.2em;
        line-height: 1;
        padding: 0 4px;
        flex-shrink: 0;
    }

    .add-task-header-btn:hover {
        color: #fff;
    }
    
    .color-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .task-items {
      padding-left: 18px;
      display: none; /* CHANGE: Hide by default */
    }

    .task-items.show {
        display: block; /* CHANGE: Show when class is added */
    }

    .new-task-input-in-group {
      display: none; 
      gap: 4px;
      margin: 4px 0;
    }

    .new-task-input-in-group.show {
        display: flex;
    }
    
    .new-task-input-in-group input {
        flex-grow: 1;
        padding: 3px 5px;
        background: var(--input-bg);
        border: 1px solid var(--cell-border);
        color: var(--text-light);
        border-radius: 3px;
        font-size: 11px;
    }
    
    .draggable {
      padding: 3px 5px;
      margin: 2px 0;
      cursor: grab;
      color: white;
      border-radius: 3px;
      font-size: 11px;
      border: 1px solid rgba(0,0,0,0.2);
    }


    .calendar-container {
      flex: 1;
      overflow: auto;
      position: relative;
    }

    .calendar {
      display: grid;
      grid-template-columns: 50px repeat(7, 1fr);
      grid-auto-rows: 30px;
      position: relative;
      min-width: 700px;
    }

    .corner-cell, .day, .time {
      position: sticky;
      background-color: var(--header-bg);
      text-align: center;
      border-bottom: 1px solid var(--cell-border);
      border-left: 1px solid var(--cell-border);
      line-height: 1; 
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .corner-cell div {
        font-size: 11px;
    }

    .corner-cell {
      grid-column: 1;
      grid-row: 1;
      top: 0;
      left: 0;
      cursor: pointer;
      z-index: 11;
    }

    .day { top: 0; z-index: 10; font-size: 12px; }
    .time { left: 0; z-index: 10; text-align: right; padding-right: 5px; font-size: 12px;}

    .cell {
      border-right: 1px solid var(--cell-border);
      border-bottom: 1px solid var(--cell-border);
      position: relative;
    }
    
    .cell:not(:first-of-type) { border-left: 1px solid var(--cell-border); }

    .cell.today {
      border-left: 2px solid var(--highlight-border);
      border-right: 2px solid var(--highlight-border);
      background-color: var(--today-bg);
    }

    .event {
      position: absolute;
      background: var(--event-bg);
      background-color: var(--event-color, var(--event-bg));
      color: #fff;
      padding: 2px 4px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.3);
      font-size: 11px;
      height: 30px; 
      box-sizing: border-box;
      cursor: grab;
      overflow: hidden;
      display: flex;
      align-items: center;
      z-index: 5;
      transition: top 0.1s ease, height 0.1s ease, left 0.1s ease, width 0.1s ease;
    }

    .event.dragging {
        opacity: 0.7;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        z-index: 1000;
    }

    .resizer {
      height: 5px;
      width: 100%;
      position: absolute;
      left: 0;
      background: rgba(255, 255, 255, 0.3);
      cursor: ns-resize;
      z-index: 6;
    }

    .resizer.top { top: 0; }
    .resizer.bottom { bottom: 0; }
    .current-time-line { position: absolute; height: 2px; background: red; z-index: 100; pointer-events: none; }
  </style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-controls">
      <div class="new-category-input">
          <input type="text" id="newCategoryName" placeholder="New Category...">
          <button id="addCategoryBtn">+</button>
      </div>
  </div>
  <div class="task-groups" id="task-groups-container">
    <!-- Categories will be dynamically inserted here -->
  </div>
</div>

<div class="calendar-container" id="calendar-container">
  <div class="calendar" id="calendar">
    <div class="corner-cell" id="corner-box" onclick="scrollToNow()">
      <div id="corner-day">Day</div>
      <div id="corner-time">00:00 AM</div>
    </div>
  </div>
  <div class="current-time-line" id="time-line"></div>
</div>

<script>
  // DOM Elements
  const calendar = document.getElementById('calendar');
  const container = document.getElementById('calendar-container');
  const timeLine = document.getElementById('time-line');
  const taskGroupsContainer = document.getElementById('task-groups-container');
  
  // State
  let dragOriginDay = null;
  const categoryColors = ['#d946ef', '#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#8b5cf6'];
  let nextColorIndex = 0;
  
  // Constants
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const hours = Array.from({ length: 24 }, (_, i) => i);
  const todayIndex = new Date().getDay();
  const rowHeight = 30;
  const halfHourHeight = rowHeight / 2;

  // --- Calendar Grid Generation ---
  function initializeCalendar() {
    days.forEach((day, i) => {
      const div = document.createElement('div');
      div.className = 'day';
      div.textContent = day;
      div.style.gridColumn = i + 2;
      div.style.gridRow = 1;
      calendar.appendChild(div);
    });

    hours.forEach((hour, rowIndex) => {
      const timeDiv = document.createElement('div');
      timeDiv.className = 'time';
      timeDiv.style.gridRow = rowIndex + 2;
      timeDiv.style.gridColumn = 1;
      timeDiv.textContent = formatHour(hour);
      calendar.appendChild(timeDiv);

      for (let col = 0; col < 7; col++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        if (col === todayIndex) cell.classList.add('today');
        cell.dataset.day = col;
        cell.dataset.hour = hour;
        cell.style.gridRow = rowIndex + 2;
        cell.style.gridColumn = col + 2;
        
        cell.ondragover = e => e.preventDefault();
        cell.ondrop = e => handleDrop(e, cell);
        calendar.appendChild(cell);
      }
    });
  }
  
  function handleDrop(e, cell) {
      e.preventDefault();
      const eventData = JSON.parse(e.dataTransfer.getData('application/json'));
      const existingEvent = document.getElementById(eventData.id);

      if (existingEvent) {
         cell.appendChild(existingEvent);
         const rect = cell.getBoundingClientRect();
         const yInCell = e.clientY - rect.top;
         const steps = Math.round(yInCell / halfHourHeight);
         existingEvent.style.top = `${steps * halfHourHeight}px`;
         
         if (dragOriginDay !== null) refreshLayoutForDay(dragOriginDay);
         refreshLayoutForDay(cell.dataset.day);
         dragOriginDay = null;
      } else {
        createEvent(cell, eventData, e.clientY);
        refreshLayoutForDay(cell.dataset.day);
      }
  }

  // --- Event Creation & Layout ---
  function createEvent(cell, eventData, clientY) {
    const event = document.createElement('div');
    event.className = 'event';
    event.id = `event-${Date.now()}`;
    event.textContent = eventData.text;
    event.style.setProperty('--event-color', eventData.color);
    
    const rect = cell.getBoundingClientRect();
    const yInCell = clientY - rect.top;
    const steps = Math.round(yInCell / halfHourHeight);
    
    event.style.top = `${steps * halfHourHeight}px`;
    event.style.height = `${rowHeight}px`;

    event.appendChild(document.createElement('div')).className = 'resizer top';
    event.appendChild(document.createElement('div')).className = 'resizer bottom';

    makeEventInteractive(event);
    cell.appendChild(event);
  }
  
  function refreshLayoutForDay(dayIndex) {
      const allEventsOnDay = Array.from(document.querySelectorAll(`.cell[data-day='${dayIndex}'] .event`));
      
      const timeSlots = {};
      
      allEventsOnDay.forEach(event => {
          const top = event.offsetTop + event.parentElement.offsetTop;
          const height = event.offsetHeight;

          for (let i = 0; i < allEventsOnDay.length; i++) {
              const otherEvent = allEventsOnDay[i];
              if(event === otherEvent) continue;
              
              const otherTop = otherEvent.offsetTop + otherEvent.parentElement.offsetTop;
              const otherHeight = otherEvent.offsetHeight;
              
              if ((top < otherTop + otherHeight) && (top + height > otherTop)) {
                  const key = Math.min(top, otherTop);
                  if(!timeSlots[key]) timeSlots[key] = new Set();
                  timeSlots[key].add(event);
                  timeSlots[key].add(otherEvent);
              }
          }
      });
      
      allEventsOnDay.forEach(e => {
        e.style.width = `calc(100% - 2px)`;
        e.style.left = `1px`;
      });
      
      Object.values(timeSlots).forEach(group => {
          const groupArray = Array.from(group);
          const width = 100 / groupArray.length;
          groupArray.forEach((ev, k) => {
              ev.style.width = `calc(${width}% - 2px)`;
              ev.style.left = `${k * width}%`;
          });
      });
  }

  // --- Helper Functions ---
  function formatHour(hour) {
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const hour12 = hour % 12 === 0 ? 12 : hour % 12;
    return `${hour12} ${ampm}`;
  }

  function toggleGroup(header) {
    const group = header.closest('.task-group');
    const items = group.querySelector('.task-items');
    items.classList.toggle('show');
  }

  // --- Time-based UI Updates ---
  function scrollToNow() {
      const now = new Date();
      const hour = now.getHours();
      const minutes = now.getMinutes();
      const offsetY = ((hour + minutes / 60) * rowHeight) - container.clientHeight / 2 + rowHeight;
      const columnWidth = (calendar.offsetWidth - 50) / 7;
      const offsetX = (todayIndex * columnWidth) - container.clientWidth / 2 + 50;
      container.scrollTo({ top: offsetY, left: offsetX, behavior: 'smooth' });
  }
  function updateCornerBox() {
      const now = new Date();
      const day = days[now.getDay()];
      const hour = now.getHours();
      const min = now.getMinutes().toString().padStart(2, '0');
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const hour12 = hour % 12 === 0 ? 12 : hour % 12;
      document.getElementById('corner-day').textContent = day;
      document.getElementById('corner-time').textContent = `${hour12}:${min} ${ampm}`;
  }
  function updateTimeLine() {
      const now = new Date();
      const hour = now.getHours();
      const minutes = now.getMinutes();
      const day = now.getDay();
      const topOffset = ((hour + minutes / 60) * rowHeight) + rowHeight;
      const column = document.querySelector(`.cell[data-day="${day}"]`);
      if (column) {
        const rect = column.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        const leftOffset = rect.left - containerRect.left + container.scrollLeft;
        timeLine.style.top = `${topOffset}px`;
        timeLine.style.left = `${leftOffset}px`;
        timeLine.style.width = `${rect.width}px`;
      }
  }
  
  // --- Sidebar Category & Task Logic ---
  function createCategory(name, color, startExpanded = false) {
    const group = document.createElement('div');
    group.className = 'task-group';

    const header = document.createElement('div');
    header.className = 'task-header';
    
    const headerTitle = document.createElement('div');
    headerTitle.className = 'task-header-title';
    headerTitle.onclick = () => toggleGroup(header); // Click title to collapse/expand

    const indicator = document.createElement('div');
    indicator.className = 'color-indicator';
    indicator.style.backgroundColor = color;

    const title = document.createElement('span');
    title.textContent = name;
    
    headerTitle.append(indicator, title);
    
    const addTaskBtnHeader = document.createElement('button');
    addTaskBtnHeader.className = 'add-task-header-btn';
    addTaskBtnHeader.textContent = '+';
    
    header.append(headerTitle, addTaskBtnHeader);

    const itemsContainer = document.createElement('div');
    itemsContainer.className = 'task-items';
    if(startExpanded) itemsContainer.classList.add('show'); // Logic to start expanded

    const taskInputContainer = document.createElement('div');
    taskInputContainer.className = 'new-task-input-in-group';

    const taskInput = document.createElement('input');
    taskInput.type = 'text';
    taskInput.placeholder = 'Add task...';
    
    addTaskBtnHeader.onclick = (e) => {
        e.stopPropagation();
        // If the main items aren't shown, show them first
        if (!itemsContainer.classList.contains('show')) {
            itemsContainer.classList.add('show');
        }
        taskInputContainer.classList.add('show');
        taskInput.focus();
    };
    
    const addTaskAction = () => {
        const taskText = taskInput.value.trim();
        if (taskText) {
            const taskEl = document.createElement('div');
            taskEl.className = 'draggable';
            taskEl.draggable = true;
            taskEl.textContent = taskText;
            taskEl.style.backgroundColor = color;
            taskEl.ondragstart = e => {
                e.stopPropagation();
                const eventData = { text: taskText, color: color, id: null };
                e.dataTransfer.setData('application/json', JSON.stringify(eventData));
            };
            itemsContainer.insertBefore(taskEl, taskInputContainer);
            taskInput.value = '';
        }
        taskInputContainer.classList.remove('show');
    };
    
    taskInput.addEventListener('keydown', (e) => {
        if(e.key === 'Enter') {
            addTaskAction();
        }
        if (e.key === 'Escape') {
            taskInput.value = '';
            taskInputContainer.classList.remove('show');
        }
    });

    taskInput.addEventListener('blur', () => {
        // Hide input if it's empty when it loses focus
        if(taskInput.value.trim() === '') {
            taskInputContainer.classList.remove('show');
        }
    });

    taskInputContainer.appendChild(taskInput);
    itemsContainer.appendChild(taskInputContainer);
    group.append(header, itemsContainer);
    taskGroupsContainer.appendChild(group);
  }
  
  function initializeSidebar() {
      const newCategoryNameInput = document.getElementById('newCategoryName');
      const addCategoryBtn = document.getElementById('addCategoryBtn');
      
      const addCategoryAction = () => {
          const name = newCategoryNameInput.value.trim();
          if (name) {
              const color = categoryColors[nextColorIndex % categoryColors.length];
              nextColorIndex++;
              createCategory(name, color, true);
              newCategoryNameInput.value = '';
          }
      };
      
      addCategoryBtn.onclick = addCategoryAction;
      newCategoryNameInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
              addCategoryAction();
          }
      });
      
      createCategory('Work', categoryColors[0], true);
      createCategory('Recreation', categoryColors[1]);
      createCategory('Exercise', categoryColors[2]);
      nextColorIndex = 3;
  }

  // --- Core Interactivity Logic ---
  function makeEventInteractive(event) {
    event.oncontextmenu = e => { e.preventDefault(); event.remove(); refreshLayoutForDay(event.parentElement.dataset.day);};
    
    const topResizer = event.querySelector('.resizer.top');
    const bottomResizer = event.querySelector('.resizer.bottom');

    const startResize = (e, isTop) => {
        e.stopPropagation(); e.preventDefault();
        event.classList.add('dragging');
        
        const startY = e.clientY;
        const startHeight = event.offsetHeight;
        const startTop = event.offsetTop;
        const initialCell = event.parentElement;
        const dayIndex = initialCell.dataset.day;
        const initialHour = parseInt(initialCell.dataset.hour, 10);

        const handleMove = (e) => {
            if (isTop) {
                const totalDeltaY = e.clientY - startY;
                const steps = Math.round(totalDeltaY / halfHourHeight);
                let snappedDeltaY = steps * halfHourHeight;
                if ((startHeight - snappedDeltaY) < halfHourHeight) snappedDeltaY = startHeight - halfHourHeight;
                const desiredHeight = startHeight - snappedDeltaY;
                const desiredTop = startTop + snappedDeltaY;
                const hourOffset = Math.floor(desiredTop / rowHeight);
                const newHour = initialHour + hourOffset;

                if (newHour >= 0 && newHour < 24) {
                    const newCell = document.querySelector(`.cell[data-day="${dayIndex}"][data-hour="${newHour}"]`);
                    if (newCell) {
                        if (event.parentElement !== newCell) newCell.appendChild(event);
                        let topInNewCell = desiredTop % rowHeight;
                        if (topInNewCell < 0) topInNewCell += rowHeight;
                        event.style.top = `${topInNewCell}px`;
                        event.style.height = `${desiredHeight}px`;
                    }
                }
            } else { // Bottom resize
                const delta = e.clientY - startY;
                const newHeight = startHeight + delta;
                const halfSteps = Math.round(newHeight / halfHourHeight);
                event.style.height = `${Math.max(halfHourHeight, halfSteps * halfHourHeight)}px`;
            }
        };

        const stopResize = () => {
            document.removeEventListener('mousemove', handleMove);
            document.removeEventListener('mouseup', stopResize);
            event.classList.remove('dragging');
            refreshLayoutForDay(dayIndex);
        };

        document.addEventListener('mousemove', handleMove);
        document.addEventListener('mouseup', stopResize);
    };

    topResizer.onmousedown = (e) => startResize(e, true);
    bottomResizer.onmousedown = (e) => startResize(e, false);

    event.draggable = true;
    event.ondragstart = e => {
      e.stopPropagation();
      dragOriginDay = event.parentElement.dataset.day;
      const eventData = {
          text: event.textContent,
          color: event.style.getPropertyValue('--event-color'),
          id: event.id
      };
      e.dataTransfer.setData('application/json', JSON.stringify(eventData));
      setTimeout(() => event.classList.add('dragging'), 0);
    };
    event.ondragend = () => event.classList.remove('dragging');
  }

  // --- App Initialization ---
  document.addEventListener('DOMContentLoaded', () => {
      initializeCalendar();
      initializeSidebar();
      updateTimeLine();
      updateCornerBox();
      scrollToNow();
      
      setInterval(() => {
        updateTimeLine();
        updateCornerBox();
      }, 60000);
      
      window.addEventListener('resize', updateTimeLine);
  });

</script>

</body>
</html>
